# vulnerability_callbacks.py
from dash import Input, Output
from data.fetch_trivy_vulnerabilities import fetch_trivy_vulnerabilities
from callbacks.viz_trivy_vulnerabilities import viz_trivy_vulnerabilities
from data.fetch_semgrep_findings import fetch_semgrep_findings
from callbacks.viz_semgrep_findings import viz_semgrep_findings

def register_vulnerability_callbacks(app):
    @app.callback(
        Output("trivy-vulnerabilities-bar-chart", "figure"),
        [
            Input("host-name-filter", "value"),
            Input("activity-status-filter", "value"),
            Input("tc-filter", "value"),
            Input("language-filter", "value"),
            Input("classification-filter", "value"),
            Input("app-id-filter", "value"),
        ],
    )
    def update_trivy(*args):
        filter_keys = [
            "host_name",
            "activity_status",
            "tc",
            "main_language",
            "classification_label",
            "app_id",
        ]
        filters = {key: (arg if arg else None) for key, arg in zip(filter_keys, args)}
        data = fetch_trivy_vulnerabilities(filters)
        return viz_trivy_vulnerabilities(data)

    @app.callback(
        Output("semgrep-findings-bar-chart", "figure"),
        [
            Input("host-name-filter", "value"),
            Input("activity-status-filter", "value"),
            Input("tc-filter", "value"),
            Input("language-filter", "value"),
            Input("classification-filter", "value"),
            Input("app-id-filter", "value"),
        ],
    )
    def update_semgrep(*args):
        filter_keys = [
            "host_name",
            "activity_status",
            "tc",
            "main_language",
            "classification_label",
            "app_id",
        ]
        filters = {key: (arg if arg else None) for key, arg in zip(filter_keys, args)}
        data = fetch_semgrep_findings(filters)
        return viz_semgrep_findings(data)